title: "TGATAA"
---
author: "David C. King"
date: "2022-10-18"
output: html_document
---

```{r setup, include=FALSE, }
knitr::opts_chunk$set(echo = TRUE)

library(Biostrings)
library(GenomicRanges)
library(tidyverse)
```


```{r data}
promoter_data = readRDS('~/work/ELT-2-ChIP-revision/David/01_promoters/03_output/promoter_data/all.df.rds') 
promoter_gr = makeGRangesFromDataFrame(promoter_data, keep.extra.columns = T, seqinfo=Seqinfo(genome="ce11"))
```



```{r pattern-matching}

matches_to_granges = function(matchobj, genome.seq) {
  # get the actual sequence matches
  step1 = extractAllMatches(genome.seq[[1]], matchobj)
  step2 = as.character(step1, check.limits = FALSE)
  step3 = split(step2, names(step2))
  glist = list()
  for (chromosome_name in names(matchobj)) {
    gr = GRanges(seqnames=chromosome_name,                                                                     ranges=matchobj[[chromosome_name]], 
                 seqinfo = Seqinfo(genome="ce11"))
  
    gr$sequence = step3[[chromosome_name]]
    glist[[chromosome_name]] = gr
  }
  unlist(GRangesList(glist) )
    
}

```


```{r sequence-data}

# "/Users/david/work/ELT-2-ChIP-revision/David/03_TGATAA"
proj_root = "../.."
genome.seq = readDNAStringSet("../../DATA/sequence/ce11_no_mito.fa")


gene_body_masks = makeGRangesFromDataFrame(
  read.table(
    file.path("..", 
              proj_root, 
              "ELT2-Metanalysis/DATA/HOT/gene_body_masks.bed")),
    seqnames.field = "V1", 
    start.field = "V2", 
    end.field = "V3", seqinfo = Seqinfo(genome="ce11")
  )
```

```{r TGATAA-matches}

genome.TGATAA = vmatchPattern('TGATAA', genome.seq)
genome.WGATAR = vmatchPattern('WGATAR', genome.seq, fixed=FALSE)

ir.TGATAA = unlist(genome.TGATAA) # IRanges object
granges.TGATAA = GRanges(
  seqnames=names(ir.TGATAA), 
  ranges=ir.TGATAA, 
  seqinfo = Seqinfo(genome="ce11"))

ir.WGATAR = unlist(genome.WGATAR) # IRanges object
granges.WGATAR = GRanges(
  seqnames=names(ir.WGATAR), 
  ranges=ir.WGATAR, 
  seqinfo = Seqinfo(genome="ce11"))
length(granges.TGATAA)
table(seqnames(granges.TGATAA))

granges.TGATAA.masked = subsetByOverlaps(granges.TGATAA,gene_body_masks)
length(granges.TGATAA.masked)
table(seqnames(granges.TGATAA.masked))

granges.WGATAR.masked = subsetByOverlaps(granges.WGATAR,gene_body_masks)
length(granges.WGATAR.masked)
table(seqnames(granges.WGATAR.masked))
```

```{r ELT-2-peak-locations}

LE_path = file.path(proj_root, "David/01_promoters/01_input/ELT2_LE_combined_IDR.df")
L1_path = file.path(proj_root, "David/01_promoters/01_input/ELT2_L1_combined_IDR.df")
L3_path = file.path(proj_root, "David/01_promoters/01_input/ELT2_L3_combined_IDR.df")

LE = read.table(LE_path)[,1:3]
L1 = read.table(L1_path)[,1:3]
L3 = read.table(L3_path)[,1:3]
ELT2.bystage = GRangesList(list(
    LE = makeGRangesFromDataFrame(LE, seqnames.field = "V1", 
                   start.field = "V2", 
                   end.field = "V3", seqinfo = Seqinfo(genome="ce11")),
    L1 = makeGRangesFromDataFrame(L1, seqnames.field = "V1", 
                   start.field = "V2", 
                   end.field = "V3", seqinfo = Seqinfo(genome="ce11")),
    L3 = makeGRangesFromDataFrame(L3, seqnames.field = "V1", 
                   start.field = "V2", 
                   end.field = "V3", seqinfo = Seqinfo(genome="ce11"))))
addmargins(table(seqnames(ELT2.bystage)),2)


ELT2.bystage.masked = GRangesList(lapply(as.list(ELT2.bystage),
          function(stage.gr){
            subsetByOverlaps(stage.gr,gene_body_masks)
          }) )
addmargins(table(seqnames(ELT2.bystage.masked)),2)
```


```{r number-of-peaks-with-tgataa}
peaks.tgataa = GRangesList(lapply(as.list(ELT2.bystage.masked),
          function(stage.gr){
            subsetByOverlaps(stage.gr,granges.TGATAA.masked)
          }) )
lapply(peaks.tgataa, length)
lapply(ELT2.bystage.masked, length)

unlist(lapply(peaks.tgataa, length))/unlist(lapply(ELT2.bystage.masked, length))
```
```{r tgataas-that-are-bound}
tgataa.w.peaks = GRangesList(lapply(as.list(ELT2.bystage.masked),
          function(stage.gr){
            subsetByOverlaps(granges.TGATAA.masked, stage.gr)
          }) )

length(granges.TGATAA.masked)
unlist(lapply(tgataa.w.peaks, length))
unlist(lapply(tgataa.w.peaks, length))/length(granges.TGATAA.masked)
```

```{r number-of-peaks-with-wgatar}
peaks.wgatar = GRangesList(lapply(as.list(ELT2.bystage.masked),
          function(stage.gr){
            subsetByOverlaps(stage.gr,granges.WGATAR.masked)
          }) )
print("number of peaks with WGATAR")
lapply(peaks.wgatar, length)
print("total numbers of peaks")
lapply(ELT2.bystage.masked, length)

print("fraction of ELT-2 peaks with WGATAR")
unlist(lapply(peaks.wgatar, length))/unlist(lapply(ELT2.bystage.masked, length))
```
```{r wgatars-that-are-bound}
wgatar.w.peaks = GRangesList(lapply(as.list(ELT2.bystage.masked),
          function(stage.gr){
            subsetByOverlaps(granges.WGATAR.masked, stage.gr)
          }) )

length(granges.WGATAR.masked)
unlist(lapply(wgatar.w.peaks, length))
unlist(lapply(wgatar.w.peaks, length))/length(granges.WGATAR.masked)
```

```{r promoters}
promoter_gr$TGATAA = countOverlaps(promoter_gr, granges.TGATAA.masked)
promoter_gr$TGATAA.bound.LE = countOverlaps(promoter_gr, tgataa.w.peaks$LE)
promoter_gr$TGATAA.bound.L1 = countOverlaps(promoter_gr, tgataa.w.peaks$L1)
promoter_gr$TGATAA.bound.L3 = countOverlaps(promoter_gr, tgataa.w.peaks$L3)
promoter_df = as.data.frame(promoter_gr)
```

```{r LE}

promoter_df %>% filter(embryo_int_exp %in% c("enriched")) %>% group_by(LE_bound, embryo_int_exp) %>% 
  summarize(n=n(),mean_TGATAA_count = mean(TGATAA), 
            mean_bound_TGATAA_count = mean(TGATAA.bound.LE),
            no_TGATAA = sum(TGATAA == 0),
            no_bound_TGATAA = sum(TGATAA.bound.LE == 0))

```

```{r L1}
promoter_df %>% filter(L1_int_exp %in% c("enriched")) %>% group_by(L1_bound, L1_int_exp) %>% 
  summarize(n=n(),mean_TGATAA_count = mean(TGATAA), 
            mean_bound_TGATAA_count = mean(TGATAA.bound.L1),
            no_TGATAA = sum(TGATAA == 0),
            no_bound_TGATAA = sum(TGATAA.bound.L1 == 0))

```

```{r L3}
promoter_df %>% filter(L3_int_exp %in% c("enriched")) %>% group_by(L3_bound, L3_int_exp) %>% 
  summarize(n=n(),mean_TGATAA_count = mean(TGATAA), 
            mean_bound_TGATAA_count = mean(TGATAA.bound.L3),
            no_TGATAA = sum(TGATAA == 0),
            no_bound_TGATAA = sum(TGATAA.bound.L3 == 0))

```