---
title: "promoter_comparison"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("devtools")
#devtools::install_github("meekrob/ParasiteXML") # Brings biomaRt, GenomicRanges
library(ParasiteXML)
library(biomaRt)
library(GenomicRanges)
```

## Promoters are upstream regions of all protein-coding genes

```{r get-promoters, warning=FALSE}
library(biomaRt)
mart = getParamart()
UPSTREAM=1000
DOWNSTREAM=200
promoters = getCElegansPromoters(mart, upstream = UPSTREAM, downstream = DOWNSTREAM) 
promoters = sort(promoters, ignore.strand=T)
head(promoters)
selfOverlaps = findOverlaps(promoters, ignore.strand=T)
#head(selfOverlaps)

# selfOverlaps includes everything against itself + overlaps between promoters
# Filter out the self hits, and retain the "between" hits as "collisions".
collisions = selfOverlaps[!isSelfHit(selfOverlaps)]

overlappingPromoterRows = unique(c( from(collisions), to(collisions)))
length(overlappingPromoterRows)
sprintf("There are %d overlaps between %d promoters.", length(collisions), length(overlappingPromoterRows))
filtered.promoters = promoters[-overlappingPromoterRows]
filtered.promoters = filtered.promoters[-which(seqnames(filtered.promoters) == 'chrM')]
sprintf("There are %d unambiguous promoters.", length(filtered.promoters))

# -500,+200
# "There are 4256 overlaps between 4067 promoters."
# "There are 15922 unambiguous promoters."

# -1000,+200
#"There are 8008 overlaps between 6749 promoters."
#"There are 13246 unambiguous promoters."

```

```{r write-promoters-bed}
dest = normalizePath("../DATA") # expected to be run in David or another user directory
fname = sprintf("%s/filtered.promoters.minus%d_plus%d.bed", dest, UPSTREAM, DOWNSTREAM)
path = (sprintf("../DATA/%s",fname))
write.table(filtered.promoters, fname, sep="\t", quote=F, row.names=F, col.names=F)
```

# Setup a conda environment in your shell
I had to call my local setup script .zshrc, where I have initialized conda,
to have access to the "base" environment, where I have installed wiggletools and ucsc user apps.

`$ wiggletools apply_paste filtered.promoters.df meanI maxI filtered.promoters.bed ELT2_LE_combined_subtracted.bw`

The same can be done for the IDR peaks.

`$ wiggletools apply_paste LE_IDR_peaks.df meanI maxI ELT2_LE_combined.IDR.bed ELT2_LE_combined_subtracted.bw`
```{r read-data, warning=FALSE}
promoters.agg = read.table("../DATA/filtered.promoters.minus1000_plus200.df")
colnames(promoters.agg) <- c("chrom", "start","end","len", "strand", "wbps_gene_id", "gene_name", "chip_signal_mean", "chip_signal_max")

IDR_peaks.agg = read.table("../DATA/LE_IDR_peaks.df")
IDR_peaks.agg$V4 = NULL
IDR_peaks.agg$V5 = NULL
IDR_peaks.agg$V6 = NULL
IDR_peaks.agg$V8 = NULL
colnames(IDR_peaks.agg) <- c("chrom", "start","end","intensity","nlogq","offset","signal.mean","signal.max")

gr.IDR = makeGRangesFromDataFrame(IDR_peaks.agg,keep.extra.columns = T)
seqinfo(gr.IDR) <- Seqinfo(genome="ce11")

gr.promoters = makeGRangesFromDataFrame(promoters.agg,keep.extra.columns = T)
seqinfo(gr.promoters) <- Seqinfo(genome="ce11")
```

```{r promoter-signal-values, warning=FALSE}
chipmean.minval = min(gr.promoters$chip_signal_mean,na.rm=T)
chipmean.minval
chipmax.minval = min(gr.promoters$chip_signal_max,na.rm=T)
chipmax.minval
chipmean.log = log(-chipmean.minval + 1 + gr.promoters$chip_signal_mean,base=2)
chipmax.log = log(-chipmax.minval + 1 + gr.promoters$chip_signal_max,base=2)

gr.promoters$log_chip_signal_mean = chipmean.log
gr.promoters$log_chip_signal_max = chipmax.log
head(gr.promoters)
write.table(as.data.frame(gr.promoters), file = "../DATA/log_filtered.promoters.minus1000_plus200.df",quote=F, row.names=F,sep="\t")
```

```{r merge-promoters-peaks}
laps = findOverlaps(gr.promoters,gr.IDR)
length(laps)
head(laps)

gr.promoters$IDR_mean = NaN
gr.promoters$IDR_max = NaN
gr.promoters[from(laps)]$IDR_max = gr.IDR[to(laps)]$signal.max
gr.promoters[from(laps)]$IDR_mean = gr.IDR[to(laps)]$signal.mean
```

(base) Cumbernauld:ELT-2-ChIP-promoters david$ bigWigInfo ELT2_LE_combined_subtracted.bw 
version: 4
isCompressed: yes
isSwapped: 0
primaryDataSize: 7,724,199
primaryIndexSize: 38,660
zoomLevels: 9
chromCount: 7
basesCovered: 35,608,464
mean: 0.350340
min: -3276.705811
max: 5699.461426
std: 46.132783

```{r}
scale_fac = 3276.705811 + 1
gr.promoters$chip_signal_max = log(scale_fac + gr.promoters$chip_signal_max)
gr.promoters$chip_signal_mean = log(scale_fac + gr.promoters$chip_signal_mean)
gr.promoters$IDR_max = log(scale_fac + gr.promoters$IDR_max)
gr.promoters$IDR_mean = log(scale_fac + gr.promoters$IDR_mean)
gr.promoters

```
```{r save-file}
write.table(as.data.frame(gr.promoters), "promoter_signal_embryo.df", row.names=F,
            col.names=T,
            quote=F,
            sep="\t")
```
